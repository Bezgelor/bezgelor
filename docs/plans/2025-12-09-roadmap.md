# Bezgelor Implementation Roadmap

**Goal:** Port NexusForever (212k LOC C# WildStar server emulator) to idiomatic Elixir.

**Approach:** Incremental phases, each producing testable functionality. Detailed implementation plans written phase-by-phase as we complete prior work.

---

## Phase 1: Foundation ✅ (Plan Complete)

**What:** Project structure, cryptography, database layer.

**Apps Created:**
- `bezgelor_core` — Types (Vector3), configuration utilities
- `bezgelor_crypto` — SRP6 authentication, packet encryption, password handling
- `bezgelor_db` — Ecto repos, Account and Character schemas

**Milestone:** Can create accounts and characters in the database. Crypto functions work correctly.

**Elixir Concepts Introduced:**
- Mix umbrella projects
- Structs and typespecs
- ExUnit testing with TDD
- Ecto schemas, changesets, migrations
- Binary operations with `:crypto`

---

## Phase 2: Protocol Layer

**What:** WildStar network protocol definitions and TCP connection handling.

**Apps Created:**
- `bezgelor_protocol` — Packet structs, binary parsing/serialization

**Key Work:**
- Port packet definitions from `NexusForever.Network.World` and `NexusForever.Network.Auth`
- Implement binary parsing using Elixir's `<<>>` pattern matching
- Set up TCP acceptor with `ranch`
- Create connection GenServer (one process per client socket)
- Implement packet framing (length-prefix, header parsing)

**Milestone:** Server accepts TCP connections, parses incoming packets into Elixir structs, can send packets back.

**Elixir Concepts Introduced:**
- Binary pattern matching (`<<header::16, length::32, payload::binary>>`)
- GenServer for stateful connections
- Ranch TCP acceptors
- Behaviours for packet handlers

**Dependencies on Phase 1:**
- Uses `bezgelor_crypto` for packet encryption/decryption

---

## Phase 3: Authentication

**What:** Complete login flow from client connection to authenticated session.

**Apps Created:**
- `bezgelor_auth` — Auth server logic, session management
- `bezgelor_sts` — Security Token Service

**Key Work:**
- Implement auth server TCP listener (port 6600)
- Handle SRP6 authentication handshake packets
- Create/verify accounts using `bezgelor_db`
- Generate and validate session tickets
- Implement STS server for NCSoft launcher compatibility

**Milestone:** Real WildStar client can connect, authenticate with email/password, and receive a valid session ticket.

**Elixir Concepts Introduced:**
- Supervision trees (auth supervisor)
- ETS for session storage
- Multi-step protocol state machines
- Process linking and monitoring

**Dependencies on Phase 2:**
- Uses `bezgelor_protocol` for packet parsing
- Uses `bezgelor_crypto.SRP6` for authentication

---

## Phase 4: Character Management

**What:** Character creation, selection, deletion, and the realm API.

**Apps Created:**
- `bezgelor_api` — Phoenix REST API

**Key Work:**
- Character creation flow (race, class, appearance)
- Character list retrieval for selection screen
- Character deletion (soft delete with restore period)
- Phoenix API for realm/character info (used by launcher)
- Port appearance/customization data structures

**Milestone:** Player can create a character, see it in character select, delete it. Phoenix API returns server status.

**Elixir Concepts Introduced:**
- Phoenix controllers and routes
- JSON serialization with Jason
- Database transactions
- Complex Ecto queries with preloads

**Dependencies on Phase 3:**
- Requires authenticated session to access character operations

---

## Phase 5: World Entry

**What:** Player enters the game world and sees their surroundings.

**Apps Created:**
- `bezgelor_world` — World server, zones, player processes
- `bezgelor_data` — Static game data (tables, definitions)

**Key Work:**
- Load static game tables into ETS (items, spells, creatures, zones)
- Implement world server TCP listener (port 24000)
- Create Zone GenServer (one per active zone)
- Create Player GenServer (one per connected player)
- Handle world entry packets (player spawns in zone)
- Send initial world state to client (terrain, nearby entities)
- Implement basic player movement

**Milestone:** Character enters world, can see terrain and move around. Position persists to database.

**Elixir Concepts Introduced:**
- Dynamic supervisors (spawn zones/players on demand)
- ETS for read-heavy game data
- Process registry (finding player/zone by ID)
- Periodic tasks (save player state)

**Dependencies on Phase 4:**
- Loads character from database
- Requires session ticket validation

---

## Phase 6: Core Gameplay

**What:** Basic game mechanics — entities, targeting, combat.

**Key Work:**
- Entity system (players, creatures, NPCs share common interface)
- Creature spawning and AI state machines
- Targeting system
- Basic spell casting (cooldowns, cast times)
- Damage calculation and health
- Death and respawn
- Experience and leveling
- Loot drops

**Milestone:** Player can target creatures, use abilities, kill them, gain XP, level up.

**Elixir Concepts Introduced:**
- Behaviours for entity types
- State machines for AI
- Pure functions for game logic (damage calc, stat formulas)
- Process message patterns (combat events)

**Dependencies on Phase 5:**
- Requires zones and player processes
- Uses static data (spell definitions, creature templates)

---

## Phase 7: Game Systems (Iterative)

**What:** Port remaining NexusForever systems one by one.

Each subsystem is a self-contained piece of work:

| System | Complexity | Description |
|--------|------------|-------------|
| **Chat** | Low | Global, zone, whisper, custom channels |
| **Social** | Low | Friends list, ignore list |
| **Mail** | Medium | Send/receive mail with attachments |
| **Guilds** | Medium | Creation, ranks, permissions, bank |
| **Inventory** | Medium | Bags, equipment, item stacking |
| **Quests** | High | Quest log, objectives, rewards |
| **Achievements** | Medium | Tracking, rewards, points |
| **Reputation** | Low | Faction standing |
| **Housing** | High | Plots, decor, visiting |
| **Mounts/Pets** | Medium | Collection, summoning |
| **Paths** | Medium | Soldier, Settler, Scientist, Explorer |
| **Tradeskills** | High | Crafting, schematics, materials |
| **Public Events** | High | World events, group objectives |
| **Dungeons** | High | Instanced content, boss mechanics |
| **PvP** | High | Battlegrounds, arenas, warplots |
| **Storefront** | Medium | In-game shop |

**Approach:** Prioritize by player-visible impact. Chat and inventory early (quality of life), complex systems like housing and dungeons later.

**Lua Scripting:** Integrated during this phase for quest behaviors, zone events, dungeon mechanics.

---

## Estimated Scope

| Phase | Approx. Tasks | Core Learning |
|-------|---------------|---------------|
| 1 | 13 | Project setup, Ecto, crypto |
| 2 | ~15-20 | Binary parsing, GenServer, TCP |
| 3 | ~15-20 | Supervision, state machines |
| 4 | ~10-15 | Phoenix, transactions |
| 5 | ~20-25 | Dynamic supervision, ETS |
| 6 | ~25-30 | Behaviours, game logic |
| 7 | ~100+ | Varies by system |

**Total:** 200+ tasks across all phases. Phase 7 alone is substantial — each system is roughly equivalent to a Phase 2-4 in size.

---

## Success Criteria by Phase

| Phase | You'll Know It Works When... |
|-------|------------------------------|
| 1 | `mix test` passes, can insert accounts/characters via IEx |
| 2 | Packet capture shows server correctly parsing client packets |
| 3 | WildStar client authenticates and reaches character select |
| 4 | Can create a character and see it in the list |
| 5 | Character loads into world, can walk around |
| 6 | Can kill a creature and gain XP |
| 7 | System-specific (e.g., can send mail, join guild, complete quest) |

---

## What's Not In Scope

These are explicitly deferred or out of scope:

- **Client modifications** — We're building a server, not modifying the client
- **Anti-cheat** — Basic validation only; no sophisticated detection
- **Horizontal scaling** — Single-node deployment; clustering is future work
- **Admin web UI** — Command-line and IEx for administration initially
- **Full WildStar content** — We port the systems, not all quest/zone data

---

## Next Steps

1. **Execute Phase 1** — Run the detailed plan in `2025-12-09-phase1-foundation.md`
2. **Write Phase 2 plan** — After Phase 1 completes, informed by what we learned
3. **Continue incrementally** — Each phase builds on the last

The detailed plan for Phase 1 is ready. Subsequent phase plans will be written as we complete prior phases.
